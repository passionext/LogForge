name: Test GCP WIF Workflow

on: [workflow_dispatch]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      # Step 1: Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2: Authenticate to GCP via Workload Identity Federation
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: "projects/862975059069/locations/global/workloadIdentityPools/github-test-pool/providers/github"
          service_account: "github-action-test-service-acc@crucial-weaver-477208-g7.iam.gserviceaccount.com"

      # Step 3: Call a public API to mimic getCurrentTime
      - name: Get current time
        id: currentTime
        run: |
          echo "TIME=$(curl -s 'https://timeapi.io/api/Time/current/zone?timeZone=Europe/Amsterdam' | jq -r '.dayOfWeek')" >> $GITHUB_ENV

      # Step 4: Call Wikipedia API based on the day of the week
      - name: Read Wikipedia
        id: wikiResult
        run: |
          DAY=$TIME
          RESULT=$(curl -s "https://en.wikipedia.org/w/api.php?action=opensearch&search=$DAY" | jq -r '.[1][0]')
          echo "WIKI_RESULT=$RESULT" >> $GITHUB_ENV

      # Step 5: Return / output the result
      - name: Show result
        run: |
          echo "Wikipedia result for today ($TIME): $WIKI_RESULT"

      # Step 6: Test gcloud authentication
      - name: Test gcloud
        run: |
          gcloud auth list
          gcloud storage ls
